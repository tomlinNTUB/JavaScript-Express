# C01-2 查詢網頁-取出單一商品


### 測試方式
```
https://自己的app名稱.herokuapp.com/product/P001
```

### 執行結果
![GitHub Logo](/imgs/B01-2.jpg)


### 網頁樣板
```
<下載>資料夾中的[網頁樣板.zip]
```

### 檔案放置方式
```
 <web>
   |
   |__ <public>
   |      |__ <css>     (由網頁樣板複製)
   |      |     |__ style.css  (自行修改)
   |      |
   |      |__ <imgs>    (由網頁樣板複製)
   |      |__ <js>      (由網頁樣板複製)
   |
   |__ <views>
   |      |__ fetchAllProducts.ejs  (前一講)   
   |      |__ fetchOneProduct.ejs   (由網頁樣板的index.ejs複製並修改)
   |
   |__ <routes>
   |      |__ <utility>  
   |      |       |__ asyncDB.js     (自行增加)
   |      |       |__ products.js    (自行增加)
   |      |
   |      |__ fetchAllProducts.js    (前一講)   
   |      |__ fetchOneProduct.js     (自行增加)
   |
   |__ app.js   (修改)
   |__ package.json    
```

### 假設
```
(1) 已安裝Node.js
(2) 已安裝Express, npm install express-generator -g
(3) 已使用Express建立網站(假設網站名稱為web), express web -ejs  
(4) 已加載PostGreSQL外掛, npm install pg --save
(5) 已在Heroku建立north-pg資料庫   
```

## 上傳至Heroku
``` 
(1) (網頁)已下載及安裝Node.js
(2) 已安裝Heroku CLI, npm install heroku -g
(3) (網頁)已下載及安裝git CLI
(4) (網頁)已登入Github
(5) (網頁)已登入Line Developer
(6) (網頁)已登入Heroku
(7) heroku login -i
(8) git config --global user.email "自己在git的email帳號"
(9) git init
(10) heroku git:remote -a [Heroku上的應用程式名稱]
---------------------------------------------------
(11) git add .
(12) git commit -am "web"
(13) git push heroku master -f
```

### (1) asyncDB.js

``` js
'use strict';

//-----------------------
// 引用資料庫模組
//-----------------------
const {Client} = require('pg');

//-----------------------
// 自己的資料庫連結位址
//-----------------------
var pgConn = 'postgres://自己的URI資料';


//產生可同步執行query物件的函式
function query(sql, value=null) {
    return new Promise((resolve, reject) => {
        //設定資料庫連線物件
        var client = new Client({
            connectionString: pgConn,
            ssl: true
        })     

        //連結資料庫
        client.connect();

        //回覆查詢結果  
        client.query(sql, value, (err, results) => {                   
            if (err){
                reject(err);
            }else{			
                resolve(results);
            }

            //關閉連線
            client.end();
        });
    });
}

//匯出
module.exports = query;
```


### (2) products.js的API說明
```
這個程式提供以下API讓前端呼叫:

1. 取出所有商品
   (1)fetchAllProducts() 
   (2)傳入值: 無
   (3)回傳值:
        |__ [{prono:商品編號, proname:商品名稱, supno:供應商編號, typno:型態編號, price:單價, stockamt:庫存量, safeamt:安全存量, inventorydate:上次盤點日, picture:圖片名稱}, ...]
        |__ [](找不到)
        |__ null(執行錯誤)
	     
2. 由商品編號取出單一商品
   (1)fetchOneProduct(prono) 
   (2)傳入值: 商品編號(string)
   (3)回傳值:
        |__ {prono:商品編號, proname:商品名稱, supno:供應商編號, typno:型態編號, price:單價, stockamt:庫存量, safeamt:安全存量, inventorydate:上次盤點日, picture:圖片名稱}
        |__ -1(找不到)
        |__ null(執行錯誤)
	
3. 取出範圍商品
   (1)fetchRangeOfProducts(start, nums) 
   (2)傳入值: 起始編號(number), 筆數(number)
   (3)回傳值:
        |__ [{prono:商品編號, proname:商品名稱, supno:供應商編號, typno:型態編號, price:單價, stockamt:庫存量, safeamt:安全存量, inventorydate:上次盤點日, picture:圖片名稱}, ...]
        |__ [](找不到)
        |__ null(執行錯誤)	
        
4. 取出某頁範圍商品
   (1)fetchPageOfProducts(pageNo) 
   (2)傳入值: 頁數(number)
   (3)回傳值:
        |__ [{prono:商品編號, proname:商品名稱, supno:供應商編號, typno:型態編號, price:單價, stockamt:庫存量, safeamt:安全存量, inventorydate:上次盤點日, picture:圖片名稱}, ...]
        |__ [](找不到)
        |__ null(執行錯誤)	        
```

### (3) products.js  
``` js
'use strict';

//引用操作資料庫的物件
const query = require('./asyncDB');

//------------------------------------------
//執行資料庫動作的函式-傳回所有產品資料
//------------------------------------------
var fetchAllProducts = async function(){
    var result={};
	
    await query('SELECT * FROM product')
        .then((data) => {            
            result = data.rows;  
        }, (error) => {
            result = null;
        });
		
    return result;
}

//------------------------------------------
//執行資料庫動作的函式-查詢單一商品
//------------------------------------------
var fetchOneProduct = async function(proNo){
    var result={};
    
    await query('SELECT * FROM product where prono = $1', [proNo])
        .then((data) => {
            if(data.rows.length > 0){
                result = data.rows[0];   
            }else{
                result = -1;
            }    
        }, (error) => {
            result = null;
        });
		
    return result;
}

//------------------------------------------
//執行資料庫動作的函式-傳回指定範圍的產品
//------------------------------------------
var fetchRangeOfProducts = async function(start=0, nums=10){
    var result={};
	
    await query('SELECT * FROM product LIMIT ?, ?', [start, nums])
        .then((data) => {
            result = data.rows;  
        }, (error) => {
            result = null;
        });
		
    return result;
}

//---------------------------------------------
//執行資料庫動作的函式-傳回分頁及指定頁面的產品
//---------------------------------------------
var fetchPageOfProducts = async function(pageNo){
    const linePerPage = 6;    //設定每頁資料筆數
    const navSegments = 10;   //設定導覽列顯示分頁數
    const startPage = Math.floor((pageNo-1) / navSegments) * navSegments + 1;  //計算導覽列的起始頁數

    var totalLine, totalPage;
    var result = {};

    await query('SELECT count(*) AS cnt FROM product')
        .then((data) => {
            totalLine = data.rows[0].cnt;
            totalPage = Math.ceil(totalLine/linePerPage);   
        }, (error) => {
            totalLine = 0;
            totalPage = 0;  
        });

    await query('SELECT * FROM product LIMIT ?, ?', [(pageNo-1)*linePerPage, linePerPage])
        .then((data) => {
            result = {data:data.rows, pageNo:pageNo, totalLine:totalLine, totalPage:totalPage, startPage:startPage, linePerPage:linePerPage, navSegments:navSegments};  
        }, (error) => {
            result = null;
        });

    return result;
}

//匯出
module.exports = {fetchAllProducts, fetchOneProduct, fetchRangeOfProducts, fetchPageOfProducts};
```


### (4) fetchOneProduct.js

``` js
var express = require('express');
var router = express.Router();

//增加引用函式
const products = require('./utility/products');

//接收GET請求
router.get('/:no', function(req, res, next) {
    var no = req.params.no;   //取出參數

    products.fetchOneProduct(no).then(data => {
        if (data==null){
            res.render('error');  //導向錯誤頁面
        }else if(data==-1){
            res.render('notFound');  //導向找不到頁面                
        }else{
            res.render('fetchOneProduct', {item:data});  //將資料傳給顯示頁面
        }  
    })
});

module.exports = router;
```

### (5) fetchAllProducts.ejs
``` html
.
. (增加以下顯示)
.

<h2>產品項目 </h2>

<table>
    <thead>
        <tr>
            <th width="20%">產品編號</th>
            <th width="35%">產品名稱</th>
            <th width="15%">單價</th>
            <th width="15%">庫存量</th>
            <th width="15%">訂貨數量</th>                        
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><%= item.prono %></td>
            <td><%= item.proname %></td>
            <td><%= item.price %></td>
            <td><%= item.stockamt %></td>
            <td><%= item.safeamt %></td>                        
        </tr> 					 
    </tbody>
</table>  

.
.
.
````     

### (6) style.css
``` css
@charset "utf-8";

/*---------------------*/
/* 修飾表格             */
/*---------------------*/
table{
    width:100%;
    border: 1px solid #666;
    border-collapse: collapse;    
}

table tr td{
    border: 1px dotted #666;    
    text-align: center;
}

/* 修飾標題列 */
table thead tr{
    height: 32px;
}

table thead th{
    border: 1px solid #666; 
    background: #aaa; 
    text-align: center;
}

/* 修飾資料列 */
table tbody tr{
    height: 30px;
}

table tbody tr:nth-child(even){
    background: #ccc;
}

/* 修飾超連結 */
table tbody tr td a{
    text-decoration: none;
    color: #000;
}

table tbody tr td a:hover{
    font-size: 19px;
    color: #333;
}


/*---------------------*/
/* 修飾分頁導覽列       */
/*---------------------*/
ul.pagination{
    margin: 0;
    margin-bottom: 5px;
    padding: 0;    
    height:40px;
    line-height:40px;
    list-style-type: none;    
}

ul.pagination li{
    width:30px;
    float:left;
}

ul.pagination li a{
    text-decoration: none;
    color: #000;
}

ul.pagination li a:hover{  
    color: #999;
    font-size:19px;
}

ul.pagination li:nth-child(1){
    width:80px;
}

ul.pagination:after{
    display: block;
    content: '';
    clear: both;
}
```

### (7) app.js
``` js
. 
.

//------------------------------------------------------------
// 增加引用模組
//------------------------------------------------------------
var fetchAllProducts = require('./routes/fetchAllProducts');
var fetchOneProduct = require('./routes/fetchOneProduct');
//------------------------------------------------------------

.
.
.

//-----------------------------------------
// 設定模組使用方式
//-----------------------------------------
app.use('/product/all', fetchAllProducts);
app.use('/product', fetchOneProduct);
//-----------------------------------------

.
.
```
