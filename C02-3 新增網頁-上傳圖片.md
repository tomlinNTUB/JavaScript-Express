# C02-3 新增網頁-上傳圖片


### 測試方式
```
https://自己的app名稱.herokuapp.com/product/addForm
```

### 執行結果
![GitHub Logo](/imgs/B02-3.jpg)


### 網頁樣板
```
<下載>資料夾中的[網頁樣板.zip]
```

### 檔案放置方式
```
 <web>
   |
   |__ <public>
   |      |__ <css>     (由網頁樣板複製)
   |      |     |__ style.css  (自行修改)
   |      |
   |      |__ <imgs>    (由網頁樣板複製)
   |      |__ <js>      (由網頁樣板複製)
   |      |__ <picture> (自行增加)   
   |              |__   (加入一張圖片)
   |
   |__ <views>
   |      |__ addProductForm.ejs    (由網頁樣板的index.ejs複製並修改)   
   |      |__ addSuccess.ejs        (由網頁樣板的index.ejs複製並修改)
   |      |__ addFail.ejs           (由網頁樣板的index.ejs複製並修改)   
   |      |__ fileSizeError.ejs     (由網頁樣板的index.ejs複製並修改)      
   |
   |__ <routes>
   |      |__ <utility>  
   |      |       |__ asyncDB.js     (自行增加)
   |      |       |__ products.js    (自行增加)
   |      |
   |      |__ addProductForm.js      (自行增加)   
   |      |__ addProduct.js          (自行增加)
   |
   |__ app.js   (修改)
   |__ package.json    
```

### 追加multer外掛
```
npm install multer --save
```

### 確認
```
已在<public>中增加<picture>資料夾, 其中已經先存一張測試圖片
```

### 假設
```
(1) 已安裝Node.js
(2) 已安裝Express, npm install express-generator -g
(3) 已使用Express建立網站(假設網站名稱為web), express web -ejs  
(4) 已加載PostGreSQL外掛, npm install pg --save
(5) 已在Heroku建立north-pg資料庫   
```

## 上傳至Heroku
``` 
(1) (網頁)已下載及安裝Node.js
(2) 已安裝Heroku CLI, npm install heroku -g
(3) (網頁)已下載及安裝git CLI
(4) (網頁)已登入Github
(5) (網頁)已登入Line Developer
(6) (網頁)已登入Heroku
(7) heroku login -i
(8) git config --global user.email "自己在git的email帳號"
(9) git init
(10) heroku git:remote -a [Heroku上的應用程式名稱]
---------------------------------------------------
(11) git add .
(12) git commit -am "web"
(13) git push heroku master -f
```

### (1) asyncDB.js

``` js
'use strict';

//-----------------------
// 引用資料庫模組
//-----------------------
const {Client} = require('pg');

//-----------------------
// 自己的資料庫連結位址
//-----------------------
var pgConn = 'postgres://自己的URI資料';


//產生可同步執行query物件的函式
function query(sql, value=null) {
    return new Promise((resolve, reject) => {
        //設定資料庫連線物件
        var client = new Client({
            connectionString: pgConn,
            ssl: true
        })     

        //連結資料庫
        client.connect();

        //回覆查詢結果  
        client.query(sql, value, (err, results) => {                   
            if (err){
                reject(err);
            }else{			
                resolve(results);
            }

            //關閉連線
            client.end();
        });
    });
}

//匯出
module.exports = query;
```


### (2) products.js的API說明
```
這個程式提供以下API讓前端呼叫:

1. 新增商品
   (1)addProduct(newData) 
   (2)傳入值: {prono:商品編號, proname:商品名稱, typno:型態編號, price:單價}
   (3)回傳值:
        |__  0: 新增成功
        |__ -1: 新增失敗   
        
2. 取出型態資料
   (1)fetchProType() 
   (2)傳入值: 無
   (3)回傳值:
        |__ [{typno:型態編號, typename:型態名稱, details:描述}, ...]
        |__ []: 無資料或錯誤          
```

### (3) products.js  
``` js
'use strict';

//引用操作資料庫的物件
const query = require('./asyncDB');

//------------------------------------------
// 新增產品資料
//------------------------------------------
var addProduct = async function(newData){
    var result;     
   
    await query('INSERT INTO product (prono, proname, typno, price, picture) VALUES ($1, $2, $3, $4, $5)', [newData.prono, newData.proname, newData.typno, newData.price, newData.picture])
        .then((data) => {
            result = 0;  
        }, (error) => {
            result = -1;
        });
		
    return result;
}

//------------------------------------------
// 取出型態資料
//------------------------------------------
var fetchProType = async function(){
    var result;

    await query('SELECT * FROM protype')
        .then((data) => {
            result = data.rows;  
        }, (error) => {
            result = [];
        });
		
    return result;
}

//匯出
module.exports = {addProduct, fetchProType};
```


### (4) addProductForm.js

``` js
var express = require('express');
var router = express.Router();

//增加引用函式
const products = require('./utility/products');

//接收GET請求
router.get('/', function(req, res, next) {
    products.fetchProType().then(d => {
        if (d!=[]){
            res.render('addProductForm', {items:d});  //轉至新增頁面
        }else{
            res.render('addFail');     //導向錯誤頁面
        }  
    });
});

module.exports = router;
```



### (5) addProduct.js

``` js
var express = require('express');
var router = express.Router();

//增加引用函式
const {addProduct} = require('./utility/products');

//---------------------------
// 引用multer外掛
//---------------------------
const multer  = require('multer');

// 宣告上傳存放空間及檔名更改
var storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, 'public/picture');
    },

    filename: function (req, file, cb) {
        cb(null, Date.now()+"--"+file.originalname);    
    }   
})

// 產生multer的上傳物件
var maxSize=300*1024;  //設定最大可接受圖片大小

var upload = multer({
    storage:storage
})
//---------------------------

//接收POST請求
router.post('/', upload.single('picture'), function(req, res, next) {
    // 如果有選擇圖片
    if (typeof req.file != 'undefined'){
        // 傳入檔案不可超過maxSize
        if(req.file.size > maxSize){
            res.render('fileSizeError');  //圖片過大
            return;
        }                      
    }  

    var prono = req.body.prono;            //取得產品編號
    var proname = req.body.proname;        //取得產品名稱
    var typno = req.body.typno;            //取得型態編號    
    var price = Number(req.body.price);    //取得價格
    var picture;                           //用來存放圖片名稱

    // 如果有選擇圖片
    if (typeof req.file != 'undefined'){
        picture=req.file.filename;   //取得上傳照片名稱
    }

    // 建立一個新資料物件
    var newData={
        prono:prono,
        proname:proname,
        typno:typno,
        price:price,
        picture:picture
    } 
    
    // 新增商品
    addProduct(newData).then(d => {
        if (d==0){
            res.render('addSuccess');  //傳至成功頁面
        }else{
            res.render('addFail');     //導向錯誤頁面
        }  
    })
});

module.exports = router;
```


### (6) addProductForm.ejs
``` html
.
. (增加以下顯示)
.

<h2>產品新增 </h2>

<form method = "post" enctype="multipart/form-data" action = "/product/add">
    <div class="form">
        <span class="name">產品編號</span>
        <span class="value"><input type="text" name="prono" maxlength="4"></span>
        <br/>
            
        <span class="name">產品名稱</span>
        <span class="value"><input type="text" name="proname" ></span>
        <br/>
            
        <span class="name">產品型別</span>
        <span class="value"> 
            <select name="typno" >
                <% for(var i=0; i<items.length; i++) {%>
                    <option value="<%= items[i].typno %>"><%= items[i].typename %></option>
                <% } %> 
            </select>
        </span>
        <br/>  
                            
        <span class="name">單價</span>
        <span class="value"><input type="number" name="price" ></span>
        <br/>
            
        <span class="name">選擇照片</span>
        <span class="value"><input type="file" name="picture" /></span>
        <br/>
                                        
        <span class="name"></span>
        <span class="value"><input type="submit" value="新增" ></span>    
    </div>    
</form>

.
.
.
````     


### (7) addSuccess.ejs
``` html
.
. (增加以下顯示)
.

<h2>產品新增成功!</h2>

.
.
.
````  


### (8) addFail.ejs
``` html
.
. (增加以下顯示)
.

<h2>產品新增失敗!</h2>

.
.
.
````  


### (9) fileSizeError.ejs
``` html
.
. (增加以下顯示)
.

<h2>圖檔過大, 上傳失敗!</h2>

.
.
.
````

### (10) style.css
``` css
@charset "utf-8";

/*---------------------*/
/* 修飾表單             */
/*---------------------*/
div.form{
    border: 1px dotted #666;
    padding: 10px 20px;
    margin: 10px 0;
}

div.form span{
    height:40px;
    line-height:40px;
}

div.form span.name{
    display:inline-block;
    width:70px;
    margin-right:10px;
    text-align:right;
}
```

### (11) app.js
``` js
. 
.

//------------------------------------------------------------
// 增加引用模組
//------------------------------------------------------------
var addProductForm = require('./routes/addProductForm');
var addProduct = require('./routes/addProduct');
//------------------------------------------------------------

.
.
.

//-----------------------------------------
// 設定模組使用方式
//-----------------------------------------
app.use('/product/addForm', addProductForm);
app.use('/product/add', addProduct);
//-----------------------------------------


//----------------------------------------
// 可直接取用檔案的資料夾
//----------------------------------------
app.use(express.static('public/picture'));
//-----------------------------------------

.
.
```
