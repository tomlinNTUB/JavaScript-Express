# B01-1 套用網頁-列出所有商品


### 測試方式
```
http://localhost:3000/products
```

### 執行結果
![GitHub Logo](/imgs/B01-1.jpg)


### 網頁樣板
```
<下載>資料夾中的[網頁樣板.zip]
```

### 檔案放置方式
```
 <web>
   |
   |__ <public>
   |      |__ <css>     (由網頁樣板複製)
   |      |     |__ style.css  (自行修改)
   |      |
   |      |__ <imgs>    (由網頁樣板複製)
   |      |__ <js>      (由網頁樣板複製)
   |
   |__ <views>
   |      |__ fetchAllProducts.ejs   (由網頁樣板的index.ejs複製並修改)
   |      
   |__ <routes>
   |      |__ <utility>  
   |      |       |__ asyncDB.js     (自行增加)
   |      |       |__ products.js    (自行增加)
   |      |
   |      |__ fetchAllProducts.js    (自行增加)
   |
   |__ app.js   (修改)
```

### 假設
```
(1) 已安裝Node.js
(2) 已安裝Express, npm install express-generator -g
(3) 已使用Express建立網站(假設網站名稱為web), express web -ejs  
(4) 已加載MySQL外掛, npm install mysql --save
(5) 已加載其他外掛, npm install
(6) 已安裝MySQL
(7) 已在MySQL中安裝north資料庫   
```


### (1) asyncDB.js

``` js
'use strict';

//引用mysql模組
var mysql = require('mysql');

//建立資料庫連接池
var pool  = mysql.createPool({
    user: 'root',
    password: 'mysql',
    host: '127.0.0.1',
    database: 'north'     
});

//產生可同步執行query物件的函式
function query(sql, value) {
    return new Promise((resolve, reject) => {
        pool.query(sql, value, function (error, results, fields) {
            if (error){
                reject(error);
            }else{
                resolve(results);
            }
        });
    });
}

//匯出
module.exports = query;
```



### (2) products.js  
``` js
'use strict';

//引用操作資料庫的物件
const query = require('./asyncDB');

//------------------------------------------
//執行資料庫動作的函式-傳回所有產品資料
//------------------------------------------
var fetchAllProducts = async function(){
    var result={};
	
    await query('SELECT * FROM product')
        .then((data) => {            
            result = {code:0, data:data};  
        }, (error) => {
            result = {code:-1};
        });
		
    return result;
}

//------------------------------------------
//執行資料庫動作的函式-查詢單一商品
//------------------------------------------
var fetchOneProduct = async function(proNo){
    var result={};
	
    await query('SELECT * FROM product where proNo = ?', proNo)
        .then((data) => {
            result = {code:0, data:data};  
        }, (error) => {
            result = {code:-1};
        });
		
    return result;
}

//------------------------------------------
//執行資料庫動作的函式-傳回指定範圍的產品
//------------------------------------------
var fetchRangeOfProducts = async function(start=0, nums=10){
    var result={};
	
    await query('SELECT * FROM product LIMIT ?, ?', [start, nums])
        .then((data) => {
            result = {code:0, data:data};  
        }, (error) => {
            result = {code:-1};
        });
		
    return result;
}

//匯出
module.exports = {fetchAllProducts, fetchOneProduct, fetchRangeOfProducts};
```


### (3) fetchAllProducts.js

``` js
var express = require('express');
var router = express.Router();

//增加引用函式
const {fetchAllProducts, fetchOneProduct, fetchRangeOfProducts} = require('./utility/products');

//接收GET請求
router.get('/', function(req, res, next) {
    fetchAllProducts().then(d => {
        if (d.code==0){
            res.render('fetchAllProducts', {items:d.data});  //將資料傳給顯示頁面
        }else{
            res.render('error');  //導向錯誤頁面
        }  
    })
});

module.exports = router;
```

### (4) fetchAllProducts.ejs
``` html
.
. (增加以下顯示)
.

<h2>產品清單 </h2>

<table class="table table-bordered productTable">
    <thead>
        <tr>
            <th width="20%">產品編號</th>
            <th width="35%">產品名稱</th>
            <th width="15%">單價</th>
            <th width="15%">庫存量</th>
            <th width="15%">訂貨數量</th>                        
        </tr>
    </thead>
    <tbody>
        <% for(var i=0; i<items.length; i++) {%>
            <tr>
                <td><a href="product/<%= items[i].proNo %>"><%= items[i].proNo %></a></td>
                <td><%= items[i].proName %></a></td>
                <td><%= items[i].price %></a></td>
                <td><%= items[i].stockAmt %></a></td>
                <td><%= items[i].orderAmt %></a></td>                        
            </tr> 
        <% } %> 
    </tbody>
</table>   

.
.
.
````     

### (5) style.css
``` css
@charset "utf-8";

/* 修飾表格 */
table{
    width:100%;
    border: 1px solid #666;
    border-collapse: collapse;    
}

table tr td{
    border: 1px dotted #666;    
    text-align: center;
}

/* 修飾標題列 */
table thead tr{
    height: 32px;
}

table thead th{
    border: 1px solid #666; 
    background: #aaa; 
    text-align: center;
}

/* 修飾資料列 */
table tbody tr{
    height: 30px;
}

table tbody tr:nth-child(even){
    background: #ccc;
}

/* 修飾超連結 */
table tbody tr td a{
    text-decoration: none;
    color: #000;
}

table tbody tr td a:hover{
    font-size: 19px;
    color: #333;
}
```

### (6) app.js
``` js
. 
.

//------------------------------------------------------------
// 增加引用模組
//------------------------------------------------------------
var fetchAllproducts = require('./routes/fetchAllproducts');
//------------------------------------------------------------

.
.
.

//------------------------------------------------------------
// 設定模組使用方式
//------------------------------------------------------------
app.use('/products', fetchAllproducts);
//------------------------------------------------------------

.
.
```
